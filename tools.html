<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/style.css">
    <title>T-BOARD GEN3 (UI2026)</title>
</head>
<body>
    <div class="container">
        <div class="top">
            <h3> <span id="top-title"></span> <span id="top-pagename"></span></h3>
            <div class="btn-group"></div>
        </div>
        <div class="middle">
            <div class="m-left">
                <div class="m-left-inner">
                    <div class="m-left-menu">
                    </div>
                </div>
            </div>
            <div class="m-right">
                <div class="m-right-inner">
                    <!-- ----------------------------- -->
                     <div style="display: flex;flex-direction: column;gap: .3rem; padding: .2rem;">

                         <div style="padding: .3rem;" class="border-basic">
                            <h4>‡πÇ‡∏ã‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</h4>
                            <form id="timezone-form">
                                <div class="form-group-h">
                                    <input type="number" name="time-offset" id="time-offset" placeholder="‡πÄ‡∏ä‡πà‡∏ô +7" value="0">
                                    <button class="btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                </div>
                            </form>
                        </div>
                        
                        <div style="padding: .3rem;" class="border-basic">
                            <h4>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h4>
                            <form id="update-password-form">
                                <div class="form-group-h">
                                    <input type="password" name="password" id="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                                    <button class="btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                </div>
                            </form>
                        </div>
                        
                        <div style="padding: .3rem;" class="border-basic">
                            <h4>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h4>
                            <button class="btn-primary" id="settingsDownloadBtn">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ‚¨á</button>
                        </div>
                        
                        <div style="padding: .3rem;" class="border-basic">
                            <h4>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h4>
                            <form id="import-settings-form">
                                <div class="form-group-h">
                                    <input type="file" name="file-settings" id="file-settings" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå settings.json">
                                    <button class="btn-primary" type="submit">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î</button>
                                </div>
                            </form>
                         </div>

                         <div style="padding: .3rem;" class="border-basic">
                            <h4>‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÅ‡∏ß‡∏£‡πå</h4>
                            <div id="firmwares-details"></div>
                         </div>

                         <div style="padding: .3rem;" class="border-basic">
                            <h4>‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÅ‡∏ß‡∏£‡πå‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h4>
                            <div id="firmwares-list" style="display: flex; flex-direction: column; gap: .3rem;"></div>
                         </div>

                         <div style="padding: .3rem;" class="border-basic">
                            <h4>‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÅ‡∏ß‡∏£‡πå‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î</h4>
                            <form id="upload-firmware-form">
                                <div class="form-group-h">
                                    <label>firmware.bin</label>
                                    <input type="file" name="file-firmware" id="file-firmware" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå settings.json" accept=".bin" required>
                                </div>
                                <div class="form-group-h">
                                    <label>littlefs.bin</label>
                                    <input type="file" name="file-littlefs" id="file-littlefs" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå settings.json" accept=".bin" required>
                                </div>
                                <div class="form-group-h">
                                    <button class="btn-primary">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î</button>
                                </div>
                            </form>
                         </div>

                         <div style="padding: .3rem;" class="border-basic">
                             <button id="rebootBtn" class="btn-yellow">‡∏£‡∏µ‡∏ö‡∏π‡πä‡∏ï üîÉ</button>
                            <button id="resetBtn" class="btn-red">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï üîÑ</button>
                         </div>

                     </div>
                    <!-- ----------------------------- -->
                </div>
            </div>
        </div>
    </div>
</body>
<script src="./js/common.js"></script>
<script>
    const timezoneFormEle = document.querySelector(`#timezone-form`)
    const timeOffsetEle = document.querySelector(`#time-offset`)
    const importSettingsFormEle = document.querySelector(`#import-settings-form`)
    const passwordEle = document.querySelector(`#password`)
    const settingsDownloadBtnEle = document.querySelector(`#settingsDownloadBtn`)
    const updatePasswordFormEle = document.querySelector(`#update-password-form`)
    const fileSettingsEle = document.querySelector(`#file-settings`)
    const firmwaresDetailsEle = document.querySelector(`#firmwares-details`)
    const firmwaresListEle = document.querySelector(`#firmwares-list`)
    const uploadFirmwareFormEle = document.querySelector(`#upload-firmware-form`)
    const fileFirmwareEle = document.querySelector(`#file-firmware`)
    const fileLittlefsEle = document.querySelector(`#file-littlefs`)
    const rebootBtnEle = document.querySelector(`#rebootBtn`)
    const resetBtnEle = document.querySelector(`#resetBtn`)

    if(reboot&&typeof reboot=="function"){
        rebootBtnEle.onclick = ()=>{
            reboot()
            setTimeout(()=>{
                window.location.reload()
            },5000)
        }
    }

    resetBtnEle.onclick = async ()=>{
        let c = confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...")
        if(!c){ return }
        LOADING.display("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...")
        const ret = await postData("/reset")
        if(res.status=="success"){
            LOADING.display("‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢...")
            setTimeout(()=>{ reboot() },1000)
            setTimeout(async()=>{ window.location.reload() },6000)
        }else{
            throw new Error("Error");
        }
    }
    settingsDownloadBtnEle.onclick = exportSetting
    importSettingsFormEle.onsubmit = importSettings
    timezoneFormEle.onsubmit = updateTimeoffset
    updatePasswordFormEle.onsubmit = updateAdminpassword
    uploadFirmwareFormEle.onsubmit = man_upgrade

    async function run() {
        await main() 
        /*-------------------*/
        const retTimeOffset = await getTimeOffset()
        if(retTimeOffset){
            timeOffsetEle.value = retTimeOffset.timeoffset
        }
        const retFirmwareVersion = await getFirmwareVersion()
        if(retFirmwareVersion){
            firmwaresDetailsEle.innerHTML = retFirmwareVersion
        }
        const retFirmwaresList = await getFirmwaresList()
        if(retFirmwaresList&&typeof retFirmwaresList == "object"&&retFirmwaresList.result){
            firmwaresListEle.innerHTML = ``
            if(Array.isArray(retFirmwaresList.result))
            {
                for (const item of retFirmwaresList.result) {
                    const itemEle = document.createElement("button")
                    itemEle.className = "btn-dark3"
                    itemEle.style.justifyContent = "start"
                    itemEle.innerHTML = `<span>(‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô ${item.version})</span> <small>${item.note}</small>`
                    itemEle.dataset.urlfs = item.url.fs
                    itemEle.dataset.urlfw = item.url.fw
                    firmwaresListEle.appendChild(itemEle)

                    itemEle.onclick = onlineUpgrade
                }
            }            
        }
        /*-------------------*/
        LOADING.hide()       
    }

    async function updateTimeoffset(e) {
        e.preventDefault()
        LOADING.display()
        let timeoffset_value = isNaN(parseFloat(timeOffsetEle.value))?0:parseFloat(timeOffsetEle.value)
        let data = { timeoffset: timeoffset_value }
        UPDATEDATA.addItem(MAC, "timeoffset", data)
        LOADING.hide()
    }
    async function updateAdminpassword(e) {
        e.preventDefault()
        let c = confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô...")
        if(!c){ return }
        LOADING.display()
        let node = e.currentTarget
        let password = passwordEle.value
        let data = { auth: btoa(`admin:${password}`) }
        UPDATEDATA.addItem(MAC, "auth", data)
        LOADING.hide()
    }

    async function exportSetting() {
        LOADING.display()
        let inputs = await getInputs()
        let outputs = await geOutputs()
        let actionbtn = await getActionbtn()
        let ping = await getPing()
        let modread = await getModbusRead()
        let modread_templates = await getModbusReadTemplatesJson()
        let modwrite = await getModbusWrite()
        let contact = await getContact()
        let scene = await getScene()
        let dataslots = await getDataslots()
        let timeoffset = await getTimeOffset()
        let template_items = await getModbusReadTemplates()
        const settings = { inputs, outputs, actionbtn, ping, modread, modread_templates, template_items, modwrite, contact, scene, timeoffset, dataslots }
        let settingsText = JSON.stringify(settings)
        const link = document.createElement("a");
        const file = new Blob([settingsText], { type: 'application/json' });
        link.href = URL.createObjectURL(file);
        link.download = `settings.json`;
        link.click();
        LOADING.hide()
        URL.revokeObjectURL(link.href);
    }

    async function importSettings(e) {
        e.preventDefault()
        const form = e.currentTarget
        const fileSettings = form.querySelector(`#file-settings`)
        if(fileSettings&&fileSettings.files&&fileSettings.files.length==1){
            const file = fileSettings.files[0]
            const str = await readStringFromFile(file)
            const json = stringIsJsonFormat(str)
            if(json){
                LOADING.display(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤...`)
                const keys = Object.keys(json)
                let all = 0
                let c = 0
                for (const key of keys) {
                    const readItem = json[key]
                    if(key=="template_items")
                    {
                        for (let tp_idx = 0; tp_idx < readItem.length; tp_idx++) {
                            const tpItem = readItem[tp_idx];
                            all+=1
                            let jsonBody = {
                                item_id:tpItem["item_id"],
                                data:tpItem
                            }
                            const ret = await postData("/modbus/templates/download","application/json",jsonBody)
                            if(ret&&ret.status&&ret.status=="success"){ c++ }
                        }
                    }else{
                        let _path = get_post_path(key)
                        if(_path!="")
                        {
                            all+=1
                            const ret = await postData(_path,"application/json",readItem)
                            if(ret&&ret.status&&ret.status=="success"){ c++ }
                        }
                    }
                    
                    LOADING.display(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${all} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${c} ... ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡∏ö‡∏π‡πä‡∏ï‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå`)
                }


                setTimeout(()=>{ reboot() }, 2000)
                setTimeout(()=>{
                    window.location.reload()
                }, 6000)
                
            }else{
                LOADING.display(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î...`)
            }
        }
        
    }


    function get_post_path(content){
        let path = ""
        switch (content) {
            case "inputs":
                path = "/inputs"
                break;
            case "outputs":
                path = "/outputs"
                break;
            case "actionbtn":
                path = "/actionbtn"
                break;
            case "ping":
                path = "/ping"
                break;
            case "modread":
                path = "/mod_read"
                break;
            case "modwrite":
                path = "/mod_write"
                break;
            case "contact":
                path = "/contact"
                break;
            case "scene":
                path = "/scene"
                break;
            case "timeoffset":
                path = "/timeoffset"
                break;
            case "dataslots":
                path = "/dataslots"
                break;
            default:
                break;
        }
        return path
    }

    async function man_upgrade(e) {
        e.preventDefault()
        let c = confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÅ‡∏ß‡∏£‡πå...`)
        if(!c){return}
        const fw = fileFirmwareEle.files[0];
        const fs = fileLittlefsEle.files[0];
        if(fw==undefined){ alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå \"firmware.bin\""); return; }
        if(fs==undefined){ alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå \"littlefs.bin\""); return; }
        if(fw.name!="firmware.bin"){ alert("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á \"firmware.bin\""); return; }
        if(fs.name!="littlefs.bin"){ alert("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á \"littlefs.bin\""); return; }

        LOADING.display("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÅ‡∏ß‡∏£‡πå‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...")

        setTimeout(async()=>{

            try {
                LOADING.display("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î firmware.bin ...")
            
                let body = fw
                let ret_fw = await fetch(HOST+"/upgrade_fw",{
                    method:"POST",
                    body
                })
            
                if(!ret_fw.ok){ alert("‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î firmware.bin ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); LOADING.hide();return; }
                LOADING.display("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î littlefs.bin ...")
                body = document.getElementById('fs').files[0];
                let ret_fs = await fetch(HOST+"/upgrade_fs",{
                    method:"POST",
                    body
                })
                if(!ret_fs.ok){ alert("‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î littlefs.bin ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); LOADING.hide();return; }
                LOADING.display("‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢...")
                setTimeout(()=>{ reboot() },1500)
                setTimeout(async()=>{ await window.location.reload() },6000)
            } catch (error) {
                alert(error.message)
                LOADING.hide()
            }

        },1000)

    }

    async function onlineUpgrade(e) {
        let node = e.currentTarget
        let c = confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÅ‡∏ß‡∏£‡πå ‡πÄ‡∏õ‡πá‡∏ô => ${node.textContent}`)
        if(!c){return}
        LOADING.display("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÅ‡∏ß‡∏£‡πå‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...")
        urlfw = node.dataset.urlfw
        urlfs = node.dataset.urlfs
        let formJson = { urlfw,urlfs }
        console.log(formJson);
        
        const ret = await postData("/upgrade","application/json",formJson)
        if(ret&&ret.status&&ret.status=="success"){
            LOADING.display("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÅ‡∏ß‡∏£‡πå‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...")
            let intervalCheckStatus = setInterval(async()=>{
                const res = await getUpgradeStatus()
                if(res&&typeof res == "object"&&Object.keys(res).includes("upgrading")){
                    if(res.upgrading===false)
                    {
                        clearInterval(intervalCheckStatus)
                        LOADING.display("‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢...")
                        setTimeout(async()=>{ window.location.reload() },6000)
                    }
                }
            },3000)
        }else{
            if(ret&&ret.message)
            {
                alert(ret.message)
            }
            window.location.reload()
        }
    }

    run()
</script>
</html>