<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/style.css">
    <title>T-BOARD GEN3 (UI2026)</title>
</head>
<body>
    <div class="container">
        <div class="top">
            <h3> <span id="top-title"></span> <span id="top-pagename"></span></h3>
            <div class="btn-group"></div>
        </div>
        <div class="middle">
            <div class="m-left">
                <div class="m-left-inner">
                    <div class="m-left-menu">
                    </div>
                </div>
            </div>
            <div class="m-right">
                <div class="m-right-inner">
                    <!-- ----------------------------- -->
                     <div style="display: flex;flex-direction: column;gap: .3rem; padding: .2rem;">

                         <div style="padding: .3rem;" class="border-basic">
                            <h4>‡πÇ‡∏ã‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</h4>
                            <form id="timezone-form">
                                <div class="form-group-h">
                                    <input type="number" name="time-offset" id="time-offset" placeholder="‡πÄ‡∏ä‡πà‡∏ô +7" value="0">
                                    <button class="btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                </div>
                            </form>
                        </div>
                        
                        <div style="padding: .3rem;" class="border-basic">
                            <h4>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h4>
                            <form id="update-password-form">
                                <div class="form-group-h">
                                    <input type="password" name="password" id="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                                    <button class="btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                </div>
                            </form>
                        </div>
                        
                        <div style="padding: .3rem;" class="border-basic">
                            <h4>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h4>
                            <button class="btn-primary" id="settingsDownloadBtn">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ‚¨á</button>
                        </div>
                        
                        <div style="padding: .3rem;" class="border-basic">
                            <h4>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h4>
                            <form id="import-settings-form">
                                <div class="form-group-h">
                                    <input type="file" name="file-settings" id="file-settings" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå settings.json">
                                    <button class="btn-primary">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î</button>
                                </div>
                            </form>
                         </div>

                         <div style="padding: .3rem;" class="border-basic">
                            <h4>‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÅ‡∏ß‡∏£‡πå</h4>
                            <div id="firmwares-details"></div>
                         </div>

                         <div style="padding: .3rem;" class="border-basic">
                            <h4>‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÅ‡∏ß‡∏£‡πå‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h4>
                            <div id="firmwares-list" style="display: flex; flex-direction: column; gap: .3rem;"></div>
                         </div>

                         <div style="padding: .3rem;" class="border-basic">
                            <h4>‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÅ‡∏ß‡∏£‡πå‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î</h4>
                            <form id="upload-firmware-form">
                                <div class="form-group-h">
                                    <label>firmware.bin</label>
                                    <input type="file" name="file-firmware" id="file-firmware" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå settings.json">
                                </div>
                                <div class="form-group-h">
                                    <label>littlefs.bin</label>
                                    <input type="file" name="file-littlefs" id="file-littlefs" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå settings.json">
                                </div>
                                <div class="form-group-h">
                                    <button class="btn-primary">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î</button>
                                </div>
                            </form>
                         </div>

                         <div style="padding: .3rem;" class="border-basic">
                             <button id="rebootBtn" class="btn-yellow">‡∏£‡∏µ‡∏ö‡∏π‡πä‡∏ï üîÉ</button>
                            <button id="resetBtn" class="btn-red">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï üîÑ</button>
                         </div>

                     </div>
                    <!-- ----------------------------- -->
                </div>
            </div>
        </div>
    </div>
</body>
<script src="./js/common.js"></script>
<script>
    const timezoneFormEle = document.querySelector(`#timezone-form`)
    const timeOffsetEle = document.querySelector(`#time-offset`)
    const importSettingsFormEle = document.querySelector(`#import-settings-form`)
    const passwordEle = document.querySelector(`#password`)
    const settingsDownloadBtnEle = document.querySelector(`#settingsDownloadBtn`)
    const updatePasswordFormEle = document.querySelector(`#update-password-form`)
    const fileSettingsEle = document.querySelector(`#file-settings`)
    const firmwaresDetailsEle = document.querySelector(`#firmwares-details`)
    const firmwaresListEle = document.querySelector(`#firmwares-list`)
    const uploadFirmwareFormEle = document.querySelector(`#upload-firmware-form`)
    const fileFirmwareEle = document.querySelector(`#file-firmware`)
    const fileLittlefsEle = document.querySelector(`#file-littlefs`)
    const rebootBtnEle = document.querySelector(`#rebootBtn`)
    const resetBtnEle = document.querySelector(`#resetBtn`)

    if(reboot&&typeof reboot=="function"){
        rebootBtnEle.onclick = ()=>{
            reboot()
            setTimeout(()=>{
                window.location.reload()
            },5000)
        }
    }

    resetBtnEle.onclick = async ()=>{
        let c = confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...")
        if(!c){ return }
        LOADING.display("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...")
        const ret = await postData("/reset")
        if(res.status=="success"){
            LOADING.display("‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢...")
            setTimeout(()=>{ reboot() },1000)
            setTimeout(async()=>{ window.location.reload() },6000)
        }else{
            throw new Error("Error");
        }
    }
    settingsDownloadBtnEle.onclick = exportSetting

    async function run() {
        await main() 
        /*-------------------*/
        const retTimeOffset = await getTimeOffset()
        if(retTimeOffset){
            console.log("retTimeOffset", retTimeOffset);            
        }
        const retFirmwareVersion = await getFirmwareVersion()
        if(retFirmwareVersion){
            firmwaresDetailsEle.innerHTML = retFirmwareVersion
        }
        // const retFirmwaresList = await getFirmwaresList()
        // if(retFirmwaresList&&typeof retFirmwaresList == "object"&&retFirmwaresList.result){
        //     firmwaresListEle.innerHTML = ``
        //     if(Array.isArray(retFirmwaresList.result))
        //     {
        //         for (const item of retFirmwaresList.result) {
        //             const itemEle = document.createElement("button")
        //             itemEle.className = "btn-dark3"
        //             itemEle.style.justifyContent = "start"
        //             itemEle.innerHTML = `<span>(‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô ${item.version})</span> <small>${item.note}</small>`
        //             itemEle.dataset.urlfs = item.url.fs
        //             itemEle.dataset.urlfw = item.url.fw
        //             firmwaresListEle.appendChild(itemEle)
        //         }
        //     }            
        // }
        /*-------------------*/
        LOADING.hide()       
    }

    async function exportSetting() {
        LOADING.display()
        let inputs = await getInputs()
        let outputs = await geOutputs()
        let actionbtn = await getActionbtn()
        let ping = await getPing()
        let modread = await getModbusRead()
        let modread_templates = await getModbusReadTemplatesJson()
        let modwrite = await getModbusWrite()
        let contact = await getContact()
        let scene = await getScene()
        let dataslots = await getDataslots()
        let timeoffset = await getTimeOffset()
        let template_items = await getModbusReadTemplates()
        const settings = { inputs, outputs, actionbtn, ping, modread, modread_templates, template_items, modwrite, contact, scene, timeoffset, dataslots }
        let settingsText = JSON.stringify(settings)
        const link = document.createElement("a");
        const file = new Blob([settingsText], { type: 'application/json' });
        link.href = URL.createObjectURL(file);
        link.download = `settings.json`;
        link.click();
        LOADING.hide()
        URL.revokeObjectURL(link.href);
    }

    run()
</script>
</html>